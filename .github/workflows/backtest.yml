name: Backtest SOT Model

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ... (load_data job remains UNCHANGED) ...

  process_data:
    name: 2. Process and Feature Engineer (O-Factors)
    needs: load_data
    runs-on: ubuntu-latest
    steps:
      # ... (setup steps remain UNCHANGED) ...
      
      - name: Download Raw Data Artifacts ðŸ“¥
        uses: actions/download-artifact@v4
        with:
          name: raw-backtest-data
          
      - name: Run Backtest Processor Script
        run: |
          echo "Running backtest_processor.py to merge and calculate O-factors..."
          python src/services/ai/backtest_processor.py 
          
      - name: Upload Final Feature Set (O-Factors) ðŸ“¤
        uses: actions/upload-artifact@v4
        with:
          name: final-feature-set
          # This artifact now contains the O-Factors
          path: final_feature_set.parquet

# ---------------------------------------------------------------------

  analyze_and_scale:
    name: 3. P-Factors, Correlation, and Scaling
    needs: process_data # This job runs ONLY after 'process_data' succeeds
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python Environment
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install -r requirements.txt
      
    - name: Download O-Factor Data ðŸ“¥
      uses: actions/download-artifact@v4
      with:
        name: final-feature-set
        
    - name: Run P-Factor Engineer Script
      # The P-Factor script will load final_feature_set.parquet and output final_feature_set_pfactors.parquet
      run: |
        echo "Running player_factor_engineer.py to calculate P-Factors..."
        python src/services/ai/player_factor_engineer.py
        
    - name: Run Correlation Analysis (Full Feature Set)
      # We need to run the correlation script again on the file that includes P-Factors
      # This requires a slight update to correlation_analysis.py to load the new file name.
      # We will address this in the next response after you confirm this step.
      run: |
        echo "Running correlation_analysis.py..."
        python src/services/ai/correlation_analysis.py 
